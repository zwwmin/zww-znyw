function ImgCut(p){var A={cutWidth:150,cutHeight:200,containerWidth:800,containerHeight:600,imageShowWidth:400,imageShowHeight:500,containerElement:"",showCutterInFirst:true,saveMode:"ratio"};$.extend(A,p);function f(F){return;var E=$("<div></div>");E.text(F);$("#debug").append(E)}function j(){$("#debug").empty()}var t=this;var b=$(A.containerElement);var o=b.find('[ui="image-editor-panel"]');var s=b.find('[ui="background-layout"]')[0];var w=b.find("[ui='cutter-layout']")[0];var c=b.find("[ui='operation-layout']")[0];var n=w.getContext("2d");var u=s.getContext("2d");var D="";var m=new Image();var x=document.createElement("canvas");var i=x.getContext("2d");var h=document.createElement("canvas");var a=h.getContext("2d");var C=document.createElement("canvas");var l=C.getContext("2d");var e=document.createElement("canvas");var q=e.getContext("2d");var g={location:{x:0,y:0},size:{w:0,h:0},ratio:1};var r={angle:0,img_bg_0:null,img_bg_90:null,img_bg_180:null,img_bg_270:null,location:{x:0,y:0},size:{w:0,h:0},originSize:{w:0,h:0},zoom:1};var d={angle:0,location:{x:0,y:0},size:{w:0,h:0},originSize:{w:0,h:0},zoom:1};var z={size:{w:0,h:0}};var B={panelInfo:{absoluteTop:0,absoluteLeft:0,offsetWidth:0,offsetHeight:0},isInDrag:false,beginPoint:{x:0,y:0},point1:{x:0,y:0},point2:{x:0,y:0},isInCut:false};var v={panelSize:{w:0,h:0},hasImage:false,imageFile:"",minScale:0,handlingMovement:false,timeSepOnHandling:25,movementInterval:null};var y={browser:{versions:function(){var E=navigator.userAgent,F=navigator.appVersion;return{trident:E.indexOf("Trident")>-1,presto:E.indexOf("Presto")>-1,webKit:E.indexOf("AppleWebKit")>-1,gecko:E.indexOf("Gecko")>-1&&E.indexOf("KHTML")==-1,mobile:!!E.match(/AppleWebKit.*Mobile.*/),ios:!!E.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:E.indexOf("Android")>-1||E.indexOf("Linux")>-1,iPhone:E.indexOf("iPhone")>-1,iPad:E.indexOf("iPad")>-1,webApp:E.indexOf("Safari")==-1}}(),language:(navigator.browserLanguage||navigator.language).toLowerCase()},GetAbsoluteLocationEx:function(G){if(arguments.length!=1||G==null){return null}var F=G;var I=F.offsetTop;var K=F.offsetLeft;var H=F.offsetWidth;var E=F.offsetHeight;while(F=F.offsetParent){if(F.style.position=="absolute"||F.style.position=="relative"||(F.style.overflow!="visible"&&F.style.overflow!="")){break}I+=F.offsetTop;K+=F.offsetLeft}var J={absoluteTop:I,absoluteLeft:K,offsetWidth:H,offsetHeight:E};return J},drawImageIOSFix:function(N,G,L,K,M,H,P,O,E,J){function F(U){var R=U.naturalWidth,Z=U.naturalHeight;var Q=document.createElement("canvas");Q.width=1;Q.height=Z;var aa=Q.getContext("2d");aa.drawImage(U,0,0);var T=aa.getImageData(0,0,1,Z).data;var X=0;var V=Z;var Y=Z;while(Y>X){var S=T[(Y-1)*4+3];if(S===0){V=Y}else{X=Y}Y=(V+X)>>1}var W=(Y/Z);return(W===0)?1:W}var I=F(G);N.drawImage(G,L*I,K*I,M*I,H*I,P,O,E,J)}};var k={init:function(){var E=this;v.panelSize.w=A.containerWidth;v.panelSize.h=A.containerHeight;if(y.browser.versions.ios==true){f("当前使用ios系统，将做特别bug修复。")}E.render_ui();E.init_cutter();E.initOperationLayout()},render_ui:function(){b.css({width:A.containerWidth+"px",height:A.containerHeight+"px"}).css("height","auto");o.css("height",A.containerHeight+"px");s.width=A.containerWidth;s.height=A.containerHeight;w.width=A.containerWidth;w.height=A.containerHeight;c.width=A.containerWidth;c.height=A.containerHeight},init_cutter:function(){var H=this;g.size.w=A.cutWidth;g.size.h=A.cutHeight;g.ratio=A.cutWidth/A.cutHeight;var E=v.panelSize.w/2;var I=v.panelSize.h/2;var G=E-g.size.w/2;var F=I-g.size.h/2;g.location.x=G;g.location.y=F;if(A.showCutterInFirst){H.updateCutter()}},updateCutter:function(){var E=this;E.__clear_cutter_canvas();E.__draw_mask();E.__draw_cutter()},__clear_cutter_canvas:function(){n.clearRect(0,0,w.width,w.height)},__draw_cutter:function(){n.strokeStyle="#ffffff";n.lineWidth=2;n.strokeRect(g.location.x,g.location.y,g.size.w,g.size.h);n.clearRect(g.location.x,g.location.y,g.size.w,g.size.h)},__draw_mask:function(){n.fillStyle="rgba(0, 0, 0, 0.3)";n.fillRect(0,0,w.width,w.height)},MoveCutter:function(F,E){var G=this;g.location.x=F;g.location.y=E;G.updateCutter()},MoveCutterByDelta:function(I,G){var F=this;var E=g.location.x+I;var H=g.location.y+G;E=parseInt(E);H=parseInt(H);if(E<0){E=0}if(H<0){H=0}if(E>(v.panelSize.w-g.size.w)){E=v.panelSize.w-g.size.w}if(H>(v.panelSize.h-g.size.h)){H=v.panelSize.h-g.size.h}F.MoveCutter(E,H)},init_background:function(E,G){var F=this;v.imageFile=G;F.init_bg_data(E,function(H){f("初始化背景时候更新背景图片。");F.updateBackground()})},init_bg_data:function(F,H){var E=this;function G(L,J){v.hasImage=true;r.originSize.w=parseInt(L);r.originSize.h=parseInt(J);r.angle=0;r.location.x=0;r.location.y=0;r.zoom=1;r.size.w=r.originSize.w;r.size.h=r.originSize.h;if(r.originSize.w>v.panelSize.w||r.originSize.h>v.panelSize.h){var I=Math.max(r.originSize.w/v.panelSize.w,r.originSize.h/v.panelSize.h);var K=parseInt(r.originSize.w/I);var M=parseInt(r.originSize.h/I);r.zoom=1/I;r.size.w=K;r.size.h=M}r.location.x=parseInt((v.panelSize.w-r.size.w)/2);r.location.y=parseInt((v.panelSize.h-r.size.h)/2);d.angle=r.angle;d.location.x=r.location.x;d.location.y=r.location.y;d.size.w=r.size.w;d.size.h=r.size.h;d.originSize.w=r.originSize.w;d.originSize.h=r.originSize.h;d.zoom=r.zoom;h.width=r.originSize.h;h.height=r.originSize.w;C.width=r.originSize.w;C.height=r.originSize.h;e.width=r.originSize.h;e.height=r.originSize.w;a.clearRect(0,0,h.width,h.height);h.width=r.originSize.h;h.height=r.originSize.w;a.save();a.rotate(Math.PI/2);a.drawImage(x,0,0-r.originSize.h);a.restore();l.clearRect(0,0,C.width,C.height);C.width=r.originSize.w;C.height=r.originSize.h;l.save();l.rotate(Math.PI);l.drawImage(x,0-r.originSize.w,0-r.originSize.h);l.restore();q.clearRect(0,0,e.width,e.height);e.width=r.originSize.h;e.height=r.originSize.w;q.save();q.rotate(Math.PI*1.5);q.drawImage(x,0-r.originSize.w,0);q.restore();v.minScale=Math.max(g.size.w/d.originSize.w,g.size.h/d.originSize.h);if(H){H()}}if(y.browser.versions.ios==true){E._setOriginCanvasInIOS(F,function(J,I){G(J,I)})}else{E._setOriginCanvasInOther(F,function(J,I){G(J,I)})}},_setOriginCanvasInIOS:function(G,H){var E=new Image();var F=new MegaPixImage(v.imageFile);E.onload=function(){var L=E.naturalWidth,R=E.naturalHeight;var K=L-L%100;var N=R-R%100;if(K<=0){K=100}if(N<=0){N=100}if(K>1400){K=1400}if(N>1400){N=1400}f("ios: 当前最大尺寸获取为[满一百]"+K+"：x "+N+" 真实尺寸为："+L+" x  "+R);var I=L;var O=R;if(L>K||R>N){var M=Math.max(L/K,R/N);var J=L/M;var Q=R/M;J=parseInt(J);Q=parseInt(Q);I=J;O=Q}f("ios: 等比例缩放尺寸为："+I+" x  "+O);E.onload=function(){};var P={maxWidth:K,maxHeight:N};F.render(x,P,function(){if(H){H(I,O,x)}})};E.src=G},_setOriginCanvasInOther:function(F,G){D=F;var E=new Image();E.onload=function(){var I=E.naturalWidth;var H=E.naturalHeight;i.clearRect(0,0,x.width,x.height);x.width=I;x.height=H;i.drawImage(E,0,0);if(G){G(I,H,x)}};E.src=F},clear_background:function(){u.clearRect(0,0,s.width,s.height)},updateBackground:function(){var E=this;E.clear_background();var I={get_x:0,get_y:0,get_w:0,get_h:0,put_x:0,put_y:0,put_w:0,put_h:0};var H="";if(d.location.x<0){I.get_x=Math.abs(d.location.x)}if(d.location.y<0){I.get_y=Math.abs(d.location.y)}I.get_w=d.size.w>v.panelSize.w?v.panelSize.w:d.size.w;I.get_h=d.size.h>v.panelSize.h?v.panelSize.h:d.size.h;if(I.get_x+d.size.w>v.panelSize.w){I.get_w=v.panelSize.w-I.get_x}if(I.get_y+d.size.h>v.panelSize.h){I.get_h=v.panelSize.h-I.get_y}if(d.location.x>0){I.put_x=d.location.x}if(d.location.y>0){I.put_y=d.location.y}I.put_w=I.get_w;I.put_h=I.get_h;I.get_x=parseInt(I.get_x/d.zoom);I.get_y=parseInt(I.get_y/d.zoom);I.get_w=parseInt(I.get_w/d.zoom);I.get_h=parseInt(I.get_h/d.zoom);if(I.get_w>d.originSize.w){I.get_w=d.originSize.w}if(I.get_h>d.originSize.h){I.get_h=d.originSize.h}var G="";var F="";if(d.angle==0||d.angle==360){G=i;F=x}else{if(d.angle==90){G=a;F=h}else{if(d.angle==180){G=l;F=C}else{if(d.angle==270){G=q;F=e}}}}window.now_context=G;window.context_bg=u;window.cut_info=I;u.drawImage(F,0,0,d.originSize.w,d.originSize.h,d.location.x,d.location.y,d.size.w,d.size.h);return;H=G.getImageData(I.get_x,I.get_y,I.get_w,I.get_h);u.save();u.scale(d.zoom,d.zoom);u.putImageData(H,0,0,I.put_x,I.put_y,I.put_w,I.put_h);u.restore()},MoveBackground:function(F,E){d.location.x=F;d.location.y=E;var G=this;G.updateBackground()},MoveBackgroundByDelta:function(H,G){var I=this;var K=d.location.x+H;var J=d.location.y+G;K=parseInt(K);J=parseInt(J);var M=0;var F=0;if(d.size.w<=g.size.w){M=0;F=v.panelSize.w-d.size.w}else{M=g.size.w-d.size.w;F=v.panelSize.w-g.size.w}var L=0;var E=0;if(d.size.h<=g.size.h){L=0;E=v.panelSize.h-d.size.h}else{L=g.size.h-d.size.h;E=v.panelSize.h-g.size.h}if(K<M){K=M}else{if(K>F){K=F}}if(J<L){J=L}else{if(J>E){J=E}}f("当前需要移动的x 和 y是："+K+" x "+J);I.MoveBackground(K,J)},ScaleBackground:function(G){var F=0;var E=0;F=d.location.x+d.size.w/2;E=d.location.y+d.size.h/2;d.zoom=G;d.size.w=parseInt(d.originSize.w*G);d.size.h=parseInt(d.originSize.h*G);var J=parseInt(F-(d.size.w)/2);var I=parseInt(E-(d.size.h)/2);d.location.x=J;d.location.y=I;var H=this;H.updateBackground()},RotateImage:function(J){var H=this;if(J!=0&&J!=90&&J!=180&&J!=270&&J!=360){return}var I=d.angle;var F=0;var E=0;F=d.location.x+d.size.w/2;E=d.location.y+d.size.h/2;if(J==0||J==360){d.angle=0;d.originSize.w=r.originSize.w;d.originSize.h=r.originSize.h}else{if(J==90){d.angle=90;d.originSize.w=r.originSize.h;d.originSize.h=r.originSize.w}else{if(J==180){d.angle=180;d.originSize.w=r.originSize.w;d.originSize.h=r.originSize.h}else{if(J==270){d.angle=270;d.originSize.w=r.originSize.h;d.originSize.h=r.originSize.w}}}}d.size.w=parseInt(d.originSize.w*d.zoom);d.size.h=parseInt(d.originSize.h*d.zoom);d.location.x=parseInt(F-(d.size.w)/2);d.location.y=parseInt(E-(d.size.h)/2);d.angle=J;var G=this;G.updateBackground()},initOperationLayout:function(){var E=this;B.panelInfo=y.GetAbsoluteLocationEx(c);if(y.browser.versions.mobile==true||y.browser.versions.mobile==true||y.browser.versions.android||y.browser.versions.iPhone){E._init_mobile_operations()}else{E._init_pc_operations()}},_init_pc_operations:function(){var E=this;$(c).mousedown(function(H){if(v.hasImage==false){return}B.isInDrag=true;B.panelInfo=y.GetAbsoluteLocationEx(c);if(B.panelInfo.absoluteLeft==0&&B.panelInfo.absoluteTop==0&&B.panelInfo.offsetHeight==0&&B.panelInfo.offsetWidth==0){}if(!H){H=window.event;c.onselectstart=function(){return false}}var J=H;var F=J.clientX;var M=J.clientY;B.beginPoint.x=F;B.beginPoint.y=M;var L=F-B.panelInfo.absoluteLeft;var K=M-B.panelInfo.absoluteTop;var I=$(document).scrollTop();if(I>0){K=K+I}var G=$(document).scrollLeft();if(G>0){L=L+G}B.point1.x=F;B.point1.y=M;B.isInCut=E.isPointInCutter(L,K)});$(document).mouseup(function(){if(v.hasImage==false){return}B.isInDrag=false});$(document).mousemove(function(H){if(v.hasImage==false){return}if(B.isInDrag==false){return}var I=H?H:window.event;var G=I.clientX,F=I.clientY;B.point2.x=G;B.point2.y=F;var K=B.point2.x-B.point1.x;var J=B.point2.y-B.point1.y;B.point1.x=G;B.point1.y=F;if(B.isInCut==true){E.MoveCutterByDelta(K,J)}else{E.MoveBackgroundByDelta(K,J)}})},_init_mobile_operations:function(){var E=this;c.addEventListener("touchstart",function(F){if(v.hasImage==false){return}if(v.movementInterval!=null){clearInterval(v.movementInterval)}if(v.handlingMovement==true){return}var J=F.changedTouches[0].pageX;var H=F.changedTouches[0].pageY;B.isInDrag=true;B.panelInfo=y.GetAbsoluteLocationEx(c);if(B.panelInfo.absoluteLeft==0&&B.panelInfo.absoluteTop==0&&B.panelInfo.offsetHeight==0&&B.panelInfo.offsetWidth==0){}var O=F;var K=J;var I=H;B.beginPoint.x=K;B.beginPoint.y=I;var N=K-B.panelInfo.absoluteLeft;var M=I-B.panelInfo.absoluteTop;var G=$(document).scrollTop();if(G>0){}var L=$(document).scrollLeft();if(L>0){}B.point1.x=K;B.point1.y=I;B.isInCut=E.isPointInCutter(N,M);F.preventDefault();F.stopPropagation()},false);c.addEventListener("touchmove",function(I){if(v.hasImage==false){return}if(B.isInDrag==false){return}if(v.handlingMovement==true){return}v.handlingMovement=true;I.preventDefault();I.stopPropagation();var J=I?I:window.event;var F=I.changedTouches[0].pageX;var M=I.changedTouches[0].pageY;var H=F,G=M;B.point2.x=H;B.point2.y=G;var L=B.point2.x-B.point1.x;var K=B.point2.y-B.point1.y;B.point1.x=H;B.point1.y=G;if(B.isInCut==true){E.MoveCutterByDelta(L,K)}else{E.MoveBackgroundByDelta(L,K)}setTimeout(function(){v.handlingMovement=false},v.timeSepOnHandling)},false);c.addEventListener("touchend",function(F){if(v.hasImage==false){return}v.handlingMovement=false;v.movementInterval=null;B.isInDrag=false;F.preventDefault();F.stopPropagation()},false)},isPointInCutter:function(H,G){var F=g.location.x;var E=g.location.y;var J=F+g.size.w;var I=E+g.size.h;if(H<F||H>J||G<E||G>I){return false}else{return true}},_cut_by_sizing:function(H){var G=document.createElement("canvas");var E=G.getContext("2d");G.width=g.size.w;G.height=g.size.h;var F=new Image();F.onload=function(){E.drawImage(F,g.location.x,g.location.y,g.size.w,g.size.h,0,0,g.size.w,g.size.h);if(H){var I=G.toDataURL("image/jpeg");H(I)}};F.src=s.toDataURL("image/jpeg")},_caculateSizeInfo:function(){var Q=g.location.x-d.location.x;var N=g.location.y-d.location.y;Q=Math.round(Q);N=Math.round(N);Q=Q/d.zoom;N=N/d.zoom;Q=Math.round(Q);N=Math.round(N);var M=g.size.w/d.zoom;var I=g.size.h/d.zoom;var G=Math.round(M);var P=Math.round(I);var K=0;var H=0;var L=0;var O=0;function E(T,U){var S={w:T,h:U,ratio:T/U};return S}var F=G/P;L=F;E(G-1,P);E(G-2,P);E(G+1,P);E(G+2,P);E(G,P-1);E(G,P-2);E(G,P+1);E(G,P+2);var J=0;var R=0;F=(G+J)/(P+R);O=Math.abs(g.ratio-F);K=(G+J);H=(P+R);var J=-1;var R=0;F=(G+J)/(P+R);if(Math.abs(g.ratio-F)<=O){O=Math.abs(g.ratio-F);K=(G+J);H=(P+R)}var J=1;var R=0;F=(G+J)/(P+R);if(Math.abs(g.ratio-F)<=O){O=Math.abs(g.ratio-F);K=(G+J);H=(P+R)}var J=0;var R=-1;F=(G+J)/(P+R);if(Math.abs(g.ratio-F)<=O){O=Math.abs(g.ratio-F);K=(G+J);H=(P+R)}var J=0;var R=1;F=(G+J)/(P+R);if(Math.abs(g.ratio-F)<=O){O=Math.abs(g.ratio-F);K=(G+J);H=(P+R)}G=K;P=H;return{x:Q,y:N,w:G,h:P}},_cut_by_ratio:function(N){var H=this;var J=H._caculateSizeInfo();var K=document.createElement("canvas");var F=K.getContext("2d");K.width=J.w;K.height=J.h;var M=null;var I;if(d.angle==0||d.angle==360){I=x;M=i}else{if(d.angle==90){I=h;M=a}else{if(d.angle==180){I=C;M=l}else{if(d.angle==270){I=e;M=q}}}}f("当前角度："+d.angle+" 当前图片尺寸： "+I.width+" x "+I.height);var L={get_x:J.x,get_y:J.y,get_w:J.w,get_h:J.h,put_x:0,put_y:0};if(L.get_x<0){L.get_w=L.get_w+L.get_x;L.put_x=Math.abs(L.get_x);L.get_x=0}if(L.get_w+L.get_x>I.width){L.get_w=(I.width-L.get_x)}if(L.get_w<0){L.get_w=1}if(L.get_y<0){L.get_h=L.get_h+L.get_y;L.put_y=Math.abs(L.get_y);L.get_y=0}if(L.get_y+L.get_h>I.height){L.get_h=(I.height-L.get_y)}if(L.get_h<0){L.get_h=1}f("裁剪信息如下：");f(JSON.stringify(L));var G=M.getImageData(L.get_x,L.get_y,L.get_w,L.get_h);if(L.put_x<=K.width&&L.put_y<K.height){F.putImageData(G,L.put_x,L.put_y)}else{f("没有执行。")}var E=K.toDataURL("image/jpeg");N(E)},cut:function(F){var E=this;if(A.saveMode=="ratio"){E._cut_by_ratio(F)}else{E._cut_by_sizing(F)}}};k.init();this.init=function(E,F){k.init_background(E,F);k.updateCutter()};this.MoveCutter=function(F,E){k.MoveCutter(F,E)};this.MoveImage=function(F,E){k.MoveBackground(F,E)};this.ScaleImage=function(E){k.ScaleBackground(E)};this.RotateImage=function(E){k.RotateImage(E)};this.hasImage=function(){return v.hasImage};this.show_data_cutter=function(){console.log(g)};this.getImageAngle=function(){return d.angle};this.getImageRotation=function(){return d.angle};this.getImageZoom=function(){return d.zoom};this.cutImg=function(E){k.cut(E)};this.getMinimizeScale=function(){var E=v.minScale;return E};this.getCutInfo=function(){return k._caculateSizeInfo()};this.getImageOriginSize=function(){return{w:d.originSize.w,h:d.originSize.h}}};
